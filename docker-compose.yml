version: '3.8'

services:
  # Shared Backend Service
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: games_industry_backend
    environment:
      # Use SQLite file inside the container
      # Implementation Note: We mount ./backend:/app, so the file is shared with host
      DATABASE_URL: sqlite:///./games_industry_jobs.db
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      # Allow CORS from frontend
      CORS_ORIGINS: "http://localhost:5173,http://localhost"
    volumes:
      - ./backend:/app
      - ./backend/logs:/app/logs
    ports:
      - "8000:8000"
    restart: unless-stopped
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # Development Frontend (Hot Reload)
  frontend-dev:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: dev
    container_name: games_industry_frontend_dev
    volumes:
      - ./frontend:/app
      - /app/node_modules
    ports:
      - "5173:5173"
    environment:
      VITE_API_URL: http://localhost:8000
    depends_on:
      - backend
    # Only start in default profile (dev)
    profiles:
      - dev
      - default

  # Production Frontend (Nginx)
  frontend-prod:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: prod # Uses multi-stage build to get nginx image
    container_name: games_industry_frontend_prod
    ports:
      - "80:80"
    depends_on:
      - backend
    # Only start when explicitly requested
    profiles:
      - production
  # Scraper Service (Optional - run manually via docker exec if needed, or scheduled)
  # Included as part of backend codebase but can be run separately if needed
  # For now, backend handles scheduling via APScheduler inside the app
